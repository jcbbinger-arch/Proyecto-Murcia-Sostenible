
import React from 'react';
import { NavLink, Link } from 'react-router-dom';
import { FileText, LayoutDashboard, DollarSign, Printer, Users, Microscope, UtensilsCrossed, Palette, Share2, Rocket, Settings, Home, GraduationCap, PenTool, Scale, Download } from 'lucide-react';
import { useProject } from '../context/ProjectContext';

interface NavItemProps {
  to: string;
  icon: React.ReactNode;
  label: string;
  colorClass: string;
}

const NavItem: React.FC<NavItemProps> = ({ to, icon, label, colorClass }) => (
  <NavLink
    to={to}
    className={({ isActive }) =>
      `flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors mb-1 ${
        isActive
          ? colorClass
          : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'
      }`
    }
  >
    {icon}
    {label}
  </NavLink>
);

export const Sidebar: React.FC = () => {
  const { state, resetProject } = useProject();

  const handleBackup = () => {
    const dataStr = JSON.stringify(state, null, 2);
    const blob = new Blob([dataStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    const safeName = state.teamName ? state.teamName.replace(/[^a-z0-9]/gi, '_').toLowerCase() : 'proyecto';
    const date = new Date().toISOString().slice(0, 10);
    
    link.href = url;
    link.download = `BACKUP_MURCIA_${safeName}_${date}.json`;
    link.click();
  };

  const creationItems = [
    { to: "/task-1", icon: <Users size={18} />, label: "1. Equipo y Zona" },
    { to: "/setup", icon: <Settings size={18} />, label: "2. Reparto Global" },
    { to: "/sync", icon: <Share2 size={18} />, label: "Sincronización" },
  ];

  const executionItems = [
    { to: "/task-2", icon: <Microscope size={18} />, label: "3. Análisis" },
    { to: "/menu", icon: <UtensilsCrossed size={18} />, label: "4. Carta" },
    { to: "/task-4", icon: <Palette size={18} />, label: "5. Prototipos" },
    { to: "/financials", icon: <DollarSign size={18} />, label: "6. Viabilidad" },
    { to: "/task-6", icon: <Rocket size={18} />, label: "7. Producción Final" },
    { to: "/co-eval", icon: <Scale size={18} />, label: "8. Coevaluación" },
    { to: "/memory", icon: <Printer size={18} />, label: "Memoria Final" },
  ];

  return (
    <aside className="w-64 bg-white border-r border-gray-200 min-h-screen flex flex-col fixed left-0 top-0 bottom-0 no-print z-10 overflow-hidden">
      <div className="p-5 border-b border-gray-100 bg-gray-50">
        <Link to="/" className="text-xl font-bold text-green-800 flex items-center gap-2 hover:opacity-80 transition-opacity">
            <FileText className="text-green-600" size={24}/>
            Murcia Sostenible
        </Link>
        <p className="text-[10px] text-gray-500 mt-1 uppercase tracking-wider font-bold">Gestor de Proyecto</p>
        {state.currentUser && (
            <div className="mt-2 bg-white border border-green-200 text-green-800 px-2 py-1.5 rounded text-xs font-bold truncate flex items-center gap-1">
                <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                {state.team.find(m => m.id === state.currentUser)?.name || 'Usuario'}
            </div>
        )}
      </div>

      <nav className="flex-1 p-4 space-y-6 overflow-y-auto">
        {/* General */}
        <div>
            <NavItem 
                to="/dashboard" 
                icon={<LayoutDashboard size={18} />} 
                label="Panel Principal" 
                colorClass="bg-gray-100 text-gray-900 font-bold"
            />
             <NavItem 
                to="/academic-guide" 
                icon={<GraduationCap size={18} />} 
                label="Guía Académica" 
                colorClass="bg-yellow-50 text-yellow-800 border border-yellow-200"
            />
        </div>

        {/* Phase 1: Creation (Blue) */}
        <div>
            <h4 className="text-[10px] uppercase font-bold text-blue-800 mb-2 px-2 flex items-center gap-1">
                <span className="w-1.5 h-1.5 rounded-full bg-blue-500"></span>
                Fase 1: Configuración
            </h4>
            <div className="border-l-2 border-blue-100 pl-2 ml-1">
                {creationItems.map(item => (
                    <NavItem 
                        key={item.to} 
                        to={item.to}
                        icon={item.icon}
                        label={item.label}
                        colorClass="bg-blue-50 text-blue-700 border border-blue-100"
                    />
                ))}
            </div>
        </div>

        {/* Phase 2: Execution (Green) */}
        <div>
            <h4 className="text-[10px] uppercase font-bold text-green-800 mb-2 px-2 flex items-center gap-1">
                <span className="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                Fase 2: Ejecución
            </h4>
            <div className="border-l-2 border-green-100 pl-2 ml-1">
                {executionItems.map(item => (
                    <NavItem 
                        key={item.to} 
                        to={item.to}
                        icon={item.icon}
                        label={item.label}
                        colorClass="bg-green-50 text-green-700 border border-green-100"
                    />
                ))}
            </div>
        </div>
      </nav>

      <div className="p-4 border-t border-gray-100 bg-gray-50">
        <div className="bg-white border border-gray-200 rounded-lg p-3 mb-3 shadow-sm">
            <p className="text-[10px] font-bold text-gray-400 uppercase mb-1">Estado del Proyecto</p>
            <div className="text-xs text-gray-600 space-y-1">
                <div className="flex justify-between">
                    <span>Equipo:</span>
                    <span>{state.teamName ? '✅' : 'Wait...'}</span>
                </div>
                <div className="flex justify-between">
                    <span>Carta:</span>
                    <span>{state.dishes.length}/4</span>
                </div>
                <div className="w-full bg-gray-100 rounded-full h-1.5 mt-2">
                    <div 
                        className="bg-green-500 h-1.5 rounded-full transition-all duration-1000" 
                        style={{ width: `${Math.min(100, (state.dishes.length / 4) * 100)}%` }}
                    ></div>
                </div>
            </div>
        </div>
        
        <button 
            onClick={handleBackup}
            className="w-full mb-2 bg-gray-800 text-white px-3 py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2 hover:bg-gray-900 transition-colors"
        >
            <Download size={14} /> Descargar Copia
        </button>

        <button 
            onClick={resetProject}
            className="w-full text-[10px] text-red-400 hover:text-red-600 hover:underline text-center mb-4"
        >
            Reiniciar Proyecto
        </button>

        {/* AUTHOR BADGE WITH CORRECTED LOGO */}
        <div className="pt-3 border-t border-gray-100 flex flex-col items-center">
            <p className="text-[10px] font-bold text-purple-900 uppercase tracking-widest mb-1.5">Created By</p>
            <div className="bg-[#0f172a] rounded-xl p-2.5 flex items-center gap-3 w-full shadow-md border border-gray-700">
                <div className="bg-white p-0.5 rounded-full w-9 h-9 flex items-center justify-center shrink-0 overflow-hidden">
                    <img src="https://lh3.googleusercontent.com/d/1DkCOqFGdw3PZbyNUnTQNgeaAGjBfv1_e" alt="JCB Logo" className="w-full h-full object-contain" referrerPolicy="no-referrer" />
                </div>
                <div className="flex-col flex overflow-hidden">
                    <span className="text-white font-bold text-xs leading-tight">Juan Codina</span>
                    <span className="text-gray-400 text-[9px] truncate">Original Design & Dev</span>
                </div>
            </div>
        </div>
      </div>
    </aside>
  );
};
